version: v1
name: "instant_grail"
description: "Holy Grail INSTANT 管線，綁定 MCP unified pipeline 與 Quantum Flow Toolkit 的三階段（解構→整合→重構）。"

triggers:
  - on_startup: true
  - event: "RUN_CREATED"
  - event: "CODE_CHANGE_DETECTED"
  - event: "CHAT_MESSAGE_CREATED"

steps:
  - id: "load_unified_pipeline"
    action: "mcp.pipeline.load"
    description: "載入 unified pipeline，確保使用 MCP 方法論。"
    inputs:
      path: "../../../mcp/pipelines/unified-pipeline-config.yaml"
    outputs:
      - pipeline_spec

  - id: "quantum_flow_alignment"
    action: "mcp.pipeline.apply"
    description: "將三階段（解構、整合、重構）映射到 Quantum Flow Toolkit。"
    depends_on:
      - "load_unified_pipeline"
    inputs:
      phases: ["deconstruct", "integrate", "refactor"]
      latency_targets:
        instant: 100
        fast: 500
        standard: 5000
        max_stage: 30000
        max_total: 180000
      parallelism:
        min_agents: 64
        max_agents: 256
      closed_loop: true
      human_intervention: 0
    outputs:
      - quantum_binding
    artifacts:
      - name: "quantum_flow_binding"
        type: "markdown"

  - id: "instant_feature_delivery"
    action: "agents.invoke"
    description: "執行 instant-feature-delivery 流水線（分析→生成→驗證→部署）。"
    agent_id: "core.orchestrator"
    depends_on:
      - "quantum_flow_alignment"
    inputs:
      pipeline: "${pipeline_spec}"
      target_pipeline: "instant-feature-delivery"
      latency_guard:
        instant: 100
        fast: 500
        standard: 5000
      human_intervention: 0
    outputs:
      - delivery_report
    artifacts:
      - name: "instant_delivery_report"
        type: "markdown"

  - id: "emit_completion_event"
    action: "events.emit"
    description: "廣播聖杯團隊完成事件，供治理與審計使用。"
    depends_on:
      - "instant_feature_delivery"
    inputs:
      event_type: "HOLY_GRAIL_TEAM_COMPLETED"
      payload:
        team_id: "holy-grail"
        pipeline: "unified-pipeline-config.yaml"
        latency: "${delivery_report.latency}"

audit:
  enabled: true
  events:
    - "PLAYBOOK_STARTED"
    - "STEP_COMPLETED"
    - "PLAYBOOK_COMPLETED"
    - "ERROR"
